---
import Sidebar from "@/components/ui/menus/Sidebar.astro";
import Plus from "@/icons/Plus.astro";
import Share from "@/icons/Share.astro";
import ProfileLayout from "@/layouts/ProfileLayout.astro";
import { supabase } from "@/lib/supabase";
import { createClient } from "@supabase/supabase-js";

const { cookies, redirect } = Astro;

// Recuperar tokens de cookies
const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return redirect("/signin");
}

// 🔑 Cliente con sesión del usuario (no el anónimo)
const supabaseServer = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_ANON_KEY,
  {
    global: {
      headers: { Authorization: `Bearer ${accessToken.value}` },
    },
  }
);

// 🔎 Verificamos que la sesión siga válida
const { data: { user }, error: userError } = await supabaseServer.auth.getUser();
if (userError || !user) {
  return redirect("/signin");
}
let profile = null;

const { data: { session } } = await supabase.auth.getSession();

if (session?.user) {
  const { data } = await supabase
    .from("profiles")
    .select("nombre, apellidos, telefono, avatar_url, bio")
    .eq("id", user.id)
    .single();
  profile = data;
}
---

<ProfileLayout user={user} displayName={profile?.nombre} avatar={profile?.avatar_url}>
  <div>
<Sidebar user={user} profile={profile} />
  <section class="max-w-4xl mx-auto mt-8 px-4">
    <!-- Cover -->
    <div class="relative rounded-xl shadow">
      <img
        src="https://images.unsplash.com/photo-1503264116251-35a269479413"
        alt="Portada"
        class="w-full h-48 object-cover"
      />

      
<div class="absolute w-full -bottom-16 md:-bottom-12 flex flex-col items-center md:flex-row md:justify-start md:space-x-4">
        <img
          id="avatar-preview"
          src={profile?.avatar_url ?? "/default-avatar.webp"}
          alt="Avatar"
          class="h-24 w-24 rounded-full border-4 border-white shadow-md object-cover"
        />
        <div class="bg-white flex flex-col  w-full p-4 shadow rounded-md text-black">
          <h1 class="text-xl font-bold ">
           {profile?.nombre} {profile?.apellidos}
          </h1>
          <!-- Acciones -->
      <div class="flex items-center flex-wrap justify-start gap-3 mt-0">
         <a href="/perfil/editar" class="px-4 py-2 rounded-lg bg-accent-a0 text-white font-medium hover:bg-accent-a10">
          Editar perfil
        </a>
        <!-- <button class="px-2 py-1 rounded-lg bg-emerald-600 text-white font-medium hover:bg-emerald-500">
          <Plus/ >Seguir
        </button>
        <button class="px-2 py-1 rounded-lg border text-emerald-700  dark:text-emerald-300 ">
          Mensaje
        </button> -->
        <button class="px-2 flex  items-center justify-center py-1 rounded-lg border bg-primary-a10 text-emerald-700 dark:text-emerald-300 hover:bg-primary-a0">
         <Share/> <span class="hidden">Compartir</span>
        </button>
      </div>

      <!-- Stats -->
      <div class="flex flex-row justify-start items-center text-center gap-3  border-t ">
        <div class="flex flex-row justify-start items-center gap-x-1">
          <p class="font-bold text-lg text-emerald-700">127</p>
          <span class="text-sm text-gray-500">Siguiendo</span>
        </div>
        <div class="flex flex-row justify-start items-center gap-x-1">
          <p class="font-bold text-lg text-emerald-700">2.8k</p>
          <span class="text-sm text-gray-500">Seguidores</span>
        </div>
        <div class="flex flex-row justify-start items-center gap-x-1">
          <p class="font-bold text-lg text-emerald-700">45</p>
          <span class="text-sm text-gray-500">Destinos</span>
        </div>
      </div>


          <p class="text-gray-700">
  {profile?.bio ?? "Aquí puedes escribir una pequeña biografía, descripción o intereses culturales del usuario."}
</p>

        </div>
       
      </div>
      
    </div>

    <div class="mt-16 bg-white dark:bg-emerald-900 border rounded-xl shadow p-6">
     

      
     

      <!-- Tabs -->
      <div class="flex justify-around mt-8 border-b">
        <button class="py-2 px-4 font-medium text-emerald-700 border-b-2 border-emerald-600">
          Posts
        </button>
        <button class="py-2 px-4 font-medium text-gray-500 hover:text-emerald-600">
          Destinos
        </button>
        <button class="py-2 px-4 font-medium text-gray-500 hover:text-emerald-600">
          Insignias
        </button>
      </div>
    </div>
  </section>
  </div>
</ProfileLayout>
